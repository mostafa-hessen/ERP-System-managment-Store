<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØµÙˆØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª â€” Returns UI (Mock)</title>
  <style>
    :root{
      --bg:#f4f7fb; --surface:#ffffff; --muted:#6b7280; --text:#0b1220;
      --primary:#0b84ff; --accent:#7c3aed; --success:#10b981; --danger:#ef4444;
      --card-shadow: 0 8px 24px rgba(2,6,23,0.06);
      --radius:10px;
      font-family: "Noto Naskh Arabic", Tahoma, Arial, sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --surface:#0f1626; --muted:#94a3b8; --text:#e6eef8;
      --card-shadow: 0 8px 24px rgba(2,6,23,0.2);
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{padding:18px;display:flex;flex-direction:column;gap:12px;height:100vh;box-sizing:border-box}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));color:white;display:flex;align-items:center;justify-content:center;font-weight:900}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316);color:#fff}
    .grid{display:grid;grid-template-columns:320px 1fr 320px;gap:14px;flex:1;align-items:stretch}
    .card{background:var(--surface);border-radius:var(--radius);padding:12px;box-shadow:var(--card-shadow);overflow:auto}
    .card h3{margin:0 0 8px 0;font-size:16px}
    input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);box-sizing:border-box}
    .invoice-row{display:flex;flex-direction:column;gap:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;cursor:pointer}
    .invoice-row.active{background:linear-gradient(90deg, rgba(11,132,255,0.06), rgba(124,58,237,0.03));border-color:rgba(11,132,255,0.18)}
    .small{font-size:13px;color:var(--muted)}
    .prod-line{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-bottom:1px dashed rgba(0,0,0,0.03)}
    .prod-left{text-align:right}
    table {width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center}
    th{background:transparent;color:var(--muted);font-weight:800;position:sticky;top:0}
    .badge{padding:6px 10px;border-radius:999px;font-weight:800}
    .badge.warn{background:rgba(250,204,21,0.12);color:#7a4f00}
    .badge.green{background:rgba(16,185,129,0.12);color:var(--success)}
    .monos{font-family:monospace}
    /* modals */
    .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:9999;padding:16px}
    .modal{width:100%;max-width:920px;background:var(--surface);padding:14px;border-radius:10px;box-shadow:var(--card-shadow);max-height:90vh;overflow:auto}
    .toast-wrap{position:fixed;top:16px;left:16px;z-index:10000;display:flex;flex-direction:column;gap:8px}
    .toast{padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
    .toast.success{background:linear-gradient(90deg,#10b981,#06b6d4)}
    .toast.error{background:linear-gradient(90deg,#ef4444,#f97316)}
    /* responsive */
    @media (max-width:1100px){ .grid{grid-template-columns:1fr; height:auto} .card{max-height:none} }
  </style>
</head>
<body data-theme="light">
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">RTN</div>
        <div>
          <div style="font-weight:900">ØµÙØ­Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (ØªØµÙˆØ±)</div>
          <div class="small">Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒÙŠÙÙŠØ© Ø¹ÙˆØ¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙÙØ¹Ø§Øª (FIFO / LIFO Ù†Ù…ÙˆØ°Ø¬)</div>
        </div>
      </div>

      <div class="controls">
        <button id="themeBtn" class="btn ghost">Ø¸Ø§Ù‡Ø±/Ø¯Ø§ÙƒÙ†</button>
        <button id="printBtn" class="btn ghost">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>

    <div class="grid">
      <!-- invoices -->
      <aside class="card" aria-label="Invoices list">
        <h3>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="invSearch" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." />
          <button id="invSearchBtn" class="btn ghost">Ø¨Ø­Ø«</button>
        </div>
        <div id="invoicesWrap" class="small"></div>
      </aside>

      <!-- items -->
      <main class="card" aria-label="Invoice items">
        <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© â€” Ø§Ù„Ø¨Ù†ÙˆØ¯</h3>
        <div id="invoiceMeta" class="small" style="margin-bottom:8px">Ø§Ø®ØªØ± ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±</div>

        <div id="itemsArea">
          <!-- table will be injected -->
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div>
            <button id="previewBtn" class="btn ghost">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
            <button id="processBtn" class="btn primary">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</button>
          </div>
          <div style="text-align:left">
            <div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <strong id="totalReturnQty">0</strong></div>
            <div class="small">Ù‚ÙŠÙ…Ø© Ù…Ø±ØªØ¬Ø¹Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: <strong id="totalReturnValue">0.00</strong> Ø¬</div>
          </div>
        </div>
      </main>

      <!-- customer & log -->
      <aside class="card" aria-label="Customer & log">
        <h3>Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <div id="custBox" class="small">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ§ØªÙˆØ±Ø©</div>
        <hr />
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
        <div id="logArea" class="small" style="max-height:50vh;overflow:auto"></div>
      </aside>
    </div>
  </div>

  <!-- FIFO modal -->
  <div id="fifoModal" class="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="fifoTitle">ØªÙØ§ØµÙŠÙ„ FIFO</h3>
          <div class="small" id="fifoSubtitle"></div>
        </div>
        <div><button id="closeFifo" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button></div>
      </div>
      <div id="fifoContent" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirmModal" class="backdrop">
    <div class="modal">
      <h3>ØªØ£ÙƒÙŠØ¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</h3>
      <div id="confirmBody" class="small" style="margin-top:8px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div>
          <button id="cancelConfirm" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="doConfirm" class="btn primary">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
        </div>
        <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±ØªØ¬Ø¹:</strong> <span id="confirmTotal">0</span></div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

<script>
/*
  Mock interactive UI for returns.
  - Stores sample invoices, items, allocations and batches in local objects.
  - Supports:
    * Selecting invoice
    * Enter return qty per item and choose restock yes/no
    * Open FIFO preview (shows how returned qty will map to allocations & how batch.remaining changes)
    * "Process" simulates applying return (updates allocations & batches locally), displays confirmation & toast
*/

document.addEventListener('DOMContentLoaded', ()=> {
  // ---------- sample data ----------
  // batches: id, product_id, remaining, unit_cost, received_at, status
  let batches = [
    {id:101, product_id:1, remaining:2.0, unit_cost:50, received_at:'2025-09-10', status:'active'},
    {id:102, product_id:1, remaining:5.0, unit_cost:55, received_at:'2025-09-20', status:'active'},
    {id:201, product_id:2, remaining:3.0, unit_cost:120, received_at:'2025-09-11', status:'active'},
    {id:202, product_id:2, remaining:0.0, unit_cost:121, received_at:'2025-09-24', status:'consumed'}
  ];

  // sale_item_allocations: id, sale_item_id, batch_id, qty, unit_cost
  let allocations = [
    {id:1, sale_item_id:11, batch_id:101, qty:2.0, unit_cost:50},
    {id:2, sale_item_id:11, batch_id:102, qty:3.0, unit_cost:55},
    {id:3, sale_item_id:12, batch_id:201, qty:1.0, unit_cost:120},
    {id:4, sale_item_id:12, batch_id:202, qty:2.0, unit_cost:121}
  ];

  // invoices: id, invoice_no, customer
  let invoices = [
    {id:1001, invoice_no:'INV-1001', customer:{name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠ',mobile:'01157787321',city:'Fayoum',address:'Sheikh Yusuf ST'}},
    {id:1002, invoice_no:'INV-1002', customer:{name:'Ø§Ø­Ù…Ø¯',mobile:'01115473776',city:'Ù…Ø¯Ø§Ø¨Øº',address:'Ø¨ÙŠØª Ø±ÙŠØ§Ù†'}}
  ];

  // invoice items: sale_item_id, invoice_id, product_id, product_name, qty, selling_price
  let invoiceItems = [
    {id:11, invoice_id:1001, product_id:1, product_name:'Ù„Ø¨Ø³', qty:5, selling_price:200},
    {id:12, invoice_id:1001, product_id:2, product_name:'ÙƒÙŠØ¨ÙˆØ±Ø¯', qty:3, selling_price:250},
    {id:21, invoice_id:1002, product_id:1, product_name:'Ù„Ø¨Ø³', qty:2, selling_price:210}
  ];

  // in-memory state
  let selectedInvoiceId = null;
  const invoicesWrap = document.getElementById('invoicesWrap');
  const invSearch = document.getElementById('invSearch');
  const invSearchBtn = document.getElementById('invSearchBtn');
  const itemsArea = document.getElementById('itemsArea');
  const custBox = document.getElementById('custBox');
  const logArea = document.getElementById('logArea');
  const fifoModal = document.getElementById('fifoModal');
  const fifoContent = document.getElementById('fifoContent');
  const fifoTitle = document.getElementById('fifoTitle');
  const fifoSubtitle = document.getElementById('fifoSubtitle');
  const totalReturnQtyEl = document.getElementById('totalReturnQty');
  const totalReturnValueEl = document.getElementById('totalReturnValue');
  const confirmModal = document.getElementById('confirmModal');
  const confirmBody = document.getElementById('confirmBody');
  const confirmTotal = document.getElementById('confirmTotal');

  function toast(msg, type='success'){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = 'toast ' + (type==='error' ? 'error' : 'success');
    el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(()=> el.style.opacity = 0, 2500);
    setTimeout(()=> el.remove(), 3000);
  }

  // render invoices list
  function renderInvoices(filter=''){
    invoicesWrap.innerHTML = '';
    const list = invoices.filter(inv => {
      if (!filter) return true;
      const q = filter.toLowerCase();
      return inv.invoice_no.toLowerCase().includes(q) || inv.customer.name.toLowerCase().includes(q);
    });
    if (!list.length) invoicesWrap.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</div>';
    list.forEach(inv=>{
      const d = document.createElement('div');
      d.className = 'invoice-row' + (selectedInvoiceId===inv.id ? ' active' : '');
      d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div style="text-align:right"><div style="font-weight:800">${inv.invoice_no}</div><div class="small">${inv.customer.name}</div></div>
        <div class="small monos">${new Date().toLocaleDateString()}</div>
      </div>`;
      d.addEventListener('click', ()=> {
        selectedInvoiceId = inv.id;
        renderInvoices(invSearch.value.trim());
        loadInvoice(inv.id);
      });
      invoicesWrap.appendChild(d);
    });
  }

  invSearchBtn.addEventListener('click', ()=> renderInvoices(invSearch.value.trim()));

  // load selected invoice items
  function loadInvoice(invId){
    const inv = invoices.find(i=> i.id===invId);
    if(!inv) return;
    const items = invoiceItems.filter(it => it.invoice_id === invId);
    custBox.innerHTML = `<div style="font-weight:800">${inv.customer.name}</div>
      <div class="small">ğŸ“ ${inv.customer.mobile}</div>
      <div class="small">ğŸ™ï¸ ${inv.customer.city}</div>
      <div class="small">ğŸ“ ${inv.customer.address}</div>
      <div style="margin-top:6px"><button id="unselectInv" class="btn ghost">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button></div>`;
    document.getElementById('unselectInv').addEventListener('click', ()=> {
      selectedInvoiceId = null; renderInvoices(); itemsArea.innerHTML=''; custBox.innerHTML = '<div class="small">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ§ØªÙˆØ±Ø©</div>';
    });

    document.getElementById('invoiceMeta').innerHTML = `<strong>${inv.invoice_no}</strong> â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: ${items.length}`;
    renderItemsTable(items);
    log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${inv.invoice_no}`);
  }

  // render items table with inputs for return qty and restock
  function renderItemsTable(items){
    let html = `<table>
      <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ù…Ø¨Ø§Ø¹</th><th>ÙƒÙ…ÙŠØ© Ù…Ø±ØªØ¬Ø¹Ø©</th><th>Ø¥Ø¹Ø§Ø¯Ø© ØªØ®Ø²ÙŠÙ†ØŸ</th><th>ØªÙØ§ØµÙŠÙ„ FIFO</th></tr></thead><tbody>`;
    items.forEach(it=>{
      // compute sum of allocations qty for info
      const allocSum = allocations.filter(a=> a.sale_item_id===it.id).reduce((s,x)=> s + x.qty, 0);
      html += `<tr>
        <td style="text-align:right"><div style="font-weight:800">${it.product_name}</div><div class="small monos">ID:${it.product_id}</div></td>
        <td>${it.qty} <div class="small">Ù…Ø®ØµÙ…: ${allocSum}</div></td>
        <td><input data-item="${it.id}" type="number" step="0.0001" min="0" class="ret-qty" style="width:100px" value="0"></td>
        <td><select data-item="${it.id}" class="restock"><option value="1">Ù†Ø¹Ù… (Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ù…Ø®Ø²Ù†)</option><option value="0">Ù„Ø§</option></select></td>
        <td><button class="btn ghost view-fifo" data-item="${it.id}">Ø¹Ø±Ø¶ FIFO</button></td>
      </tr>`;
    });
    html += '</tbody></table>';
    itemsArea.innerHTML = html;

    // attach handlers
    document.querySelectorAll('.view-fifo').forEach(b=> b.addEventListener('click', (e)=> {
      const id = Number(b.dataset.item);
      openFifoForItem(id);
    }));
    document.querySelectorAll('.ret-qty').forEach(inp=> inp.addEventListener('input', recalcTotals));
    document.querySelectorAll('.restock').forEach(sel=> sel.addEventListener('change', recalcTotals));
    recalcTotals();
  }

  // recalc totals
  function recalcTotals(){
    let totalQty = 0; let totalVal = 0;
    document.querySelectorAll('.ret-qty').forEach(inp=>{
      const itemId = Number(inp.dataset.item);
      const qty = parseFloat(inp.value || 0);
      if (qty > 0) {
        const it = invoiceItems.find(x=> x.id===itemId);
        totalQty += qty;
        totalVal += qty * (it ? it.selling_price : 0);
      }
    });
    totalReturnQtyEl.textContent = totalQty.toFixed(4);
    totalReturnValueEl.textContent = totalVal.toFixed(2);
  }

  // open FIFO preview for one sale item (simulate reverse allocation -> LIFO)
  function openFifoForItem(saleItemId){
    const it = invoiceItems.find(x=> x.id === saleItemId);
    if (!it) { toast('Ø§Ù„Ø¨Ù†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); return; }
    fifoTitle.textContent = `ØªÙØ§ØµÙŠÙ„ FIFO â€” ${it.product_name}`;
    const qtyInput = document.querySelector(`.ret-qty[data-item="${saleItemId}"]`);
    const qtyRequested = parseFloat(qtyInput ? (qtyInput.value || 0) : 0);

    // gather allocations for this sale_item, order by id asc (older first); for reverse allocation we'll use reverse order
    const allocs = allocations.filter(a=> a.sale_item_id === saleItemId).map(a => ({...a}));
    if (!allocs.length) {
      fifoContent.innerHTML = `<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ®ØµÙŠØµØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯.</div>`;
      fifoSubtitle.textContent = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${batches.filter(b=> b.product_id===it.product_id).reduce((s,b)=> s + b.remaining, 0)} ÙˆØ­Ø¯Ø©`;
      fifoModal.style.display = 'flex';
      return;
    }

    // Compute how return qty will map to allocations (LIFO: last allocations first)
    // Show table: batch id | ØªØ§Ø±ÙŠØ® | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø¢Ù† | Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ | Ù…Ø£Ø®ÙˆØ° (Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹) | ØªÙƒÙ„ÙØ©
    let need = qtyRequested;
    let rows = [];
    // we'll iterate allocations from last to first
    for (let i = allocs.length - 1; i >= 0 && need > 0; i--) {
      const a = allocs[i];
      const batch = batches.find(b=> b.id === a.batch_id);
      const availAllocQty = a.qty; // how much was allocated originally
      const take = Math.min(availAllocQty, need);
      const beforeBatchRemaining = batch ? batch.remaining : 0;
      const afterBatchRemaining = beforeBatchRemaining + take; // because return will add back if restock
      rows.push({
        batch_id: a.batch_id,
        received_at: batch ? batch.received_at : '-',
        before: beforeBatchRemaining,
        unit_cost: a.unit_cost,
        taken: take,
        cost: take * a.unit_cost,
        after: afterBatchRemaining
      });
      need -= take;
    }

    // render
    let html = `<div class="small">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ø±Ø¬Ø¹: <strong>${qtyRequested}</strong> â€” (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù‡Ù†Ø§: ÙŠØ±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¯ÙÙØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© â€” LIFO)</div>`;
    html += `<table style="margin-top:10px"><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø¢Ù†</th><th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ù…Ø£Ø®ÙˆØ°</th><th>ØªÙƒÙ„ÙØ©</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹</th></tr></thead><tbody>`;
    let totalCost = 0;
    rows.forEach(r=>{
      totalCost += r.cost;
      html += `<tr>
        <td class="monos">${r.batch_id}</td>
        <td class="small monos">${r.received_at}</td>
        <td>${r.before.toFixed(4)}</td>
        <td class="monos">${r.unit_cost.toFixed(2)}</td>
        <td>${r.taken.toFixed(4)}</td>
        <td>${r.cost.toFixed(2)}</td>
        <td>${r.after.toFixed(4)}</td>
      </tr>`;
    });
    if (need > 0) {
      html += `<tr><td colspan="7" style="color:${'rgb(185 28 28)'}">ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù…Ø®ØµØµØ© â€” Ù„Ù… ÙŠØªÙ… ØªØºØ·ÙŠØ© ${need.toFixed(4)} ÙˆØ­Ø¯Ø©</td></tr>`;
    }
    html += `</tbody></table>`;
    html += `<div style="margin-top:8px"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</strong> ${totalCost.toFixed(2)} Ø¬</div>`;

    fifoContent.innerHTML = html;
    fifoSubtitle.textContent = `Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${batches.filter(b=> b.product_id===it.product_id).reduce((s,b)=> s + b.remaining, 0)} ÙˆØ­Ø¯Ø©`;
    fifoModal.style.display = 'flex';
  }

  document.getElementById('closeFifo').addEventListener('click', ()=> fifoModal.style.display='none');

  // process returns: open confirm modal summarizing requested returns
  document.getElementById('processBtn').addEventListener('click', ()=> {
    if (!selectedInvoiceId) { toast('Ø§Ø®ØªØ± ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹','error'); return; }
    // collect requested items
    const selected = [];
    document.querySelectorAll('.ret-qty').forEach(inp=>{
      const id = Number(inp.dataset.item);
      const qty = parseFloat(inp.value || 0);
      if (qty > 0) {
        const restock = document.querySelector(`.restock[data-item="${id}"]`).value === '1';
        const it = invoiceItems.find(x=> x.id===id);
        selected.push({...it, qty_return:qty, restock});
      }
    });
    if (!selected.length) { toast('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª Ù…Ø±Ø¬Ø¹Ø©','error'); return; }

    // build confirm body
    let html = `<div>ÙØ§ØªÙˆØ±Ø©: <strong>${invoices.find(i=> i.id===selectedInvoiceId).invoice_no}</strong></div>`;
    html += `<div style="margin-top:8px"><table><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>ÙƒÙ…ÙŠØ© Ù…Ø±Ø¬Ø¹Ø©</th><th>Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ù…Ø®Ø²Ù†</th><th>Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody>`;
    let tot=0;
    selected.forEach(s=>{
      const val = s.qty_return * s.selling_price;
      tot += val;
      html += `<tr><td style="text-align:right">${s.product_name}</td><td>${s.qty_return}</td><td>${s.restock ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td><td>${val.toFixed(2)}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    html += `<div style="margin-top:8px"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:</strong> ${tot.toFixed(2)} Ø¬</div>`;
    confirmBody.innerHTML = html;
    confirmTotal.textContent = tot.toFixed(2);
    confirmModal.style.display = 'flex';
  });

  // cancel confirm
  document.getElementById('cancelConfirm').addEventListener('click', ()=> confirmModal.style.display='none');

  // do confirm -> apply changes locally (simulate DB ops)
  document.getElementById('doConfirm').addEventListener('click', ()=> {
    // collect selected items like above
    const selected = [];
    document.querySelectorAll('.ret-qty').forEach(inp=>{
      const id = Number(inp.dataset.item);
      const qty = parseFloat(inp.value || 0);
      if (qty > 0) {
        const restock = document.querySelector(`.restock[data-item="${id}"]`).value === '1';
        const it = invoiceItems.find(x=> x.id===id);
        selected.push({...it, qty_return:qty, restock});
      }
    });

    // For each selected, try to apply reverse allocation on allocations list (modify allocations and batches)
    let error = null;
    selected.forEach(s=>{
      let need = s.qty_return;
      // get allocations for sale_item ordered oldest->newest (we'll process reverse)
      const allocs = allocations.filter(a=> a.sale_item_id === s.id);
      // check total alloc qty available
      const totalAlloc = allocs.reduce((sum,a)=> sum + a.qty, 0);
      if (need > totalAlloc + 0.00001) {
        error = `Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù„Ù„Ø¨Ù†Ø¯ ${s.product_name} Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®ØµØµ (Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ ${totalAlloc})`;
        return;
      }
      // iterate allocations from last to first
      for (let i = allocs.length - 1; i >= 0 && need > 0; i--) {
        const a = allocs[i];
        const take = Math.min(a.qty, need);
        // reduce allocation qty
        a.qty = +(a.qty - take).toFixed(4);
        // update in global allocations
        const idx = allocations.findIndex(x=> x.id === a.id);
        if (idx >= 0) allocations[idx].qty = a.qty;
        // if restock -> add to batch.remaining
        if (s.restock) {
          const bIdx = batches.findIndex(b=> b.id === a.batch_id);
          if (bIdx >= 0) {
            batches[bIdx].remaining = +(batches[bIdx].remaining + take).toFixed(4);
            // if batch was consumed and now has remaining > 0, set active
            if (batches[bIdx].status === 'consumed' && batches[bIdx].remaining > 0) batches[bIdx].status = 'active';
          }
        }
        // log one allocation reversed
        log(`Ù…Ø±Ø¬Ø¹: Ø¨Ù†Ø¯ ${s.product_name} â€” Ø£ÙØ¹ÙŠØ¯ ${take} Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø© ${a.batch_id}${s.restock ? ' (Ø£ÙØ¹ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)' : ' (Ù„Ù… ÙŠÙØ¹Ø§Ø¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†)'}`);
        need = +(need - take).toFixed(4);
      }
    });

    if (error) { toast(error,'error'); confirmModal.style.display='none'; return; }
    toast('ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù…Ø­Ø§ÙƒØ§Ø©)', 'success');
    confirmModal.style.display='none';
    // refresh view
    if (selectedInvoiceId) loadInvoice(selectedInvoiceId);
    recalcTotals(); // totals based on inputs (could clear inputs if desired)
  });

  // printing simple preview
  document.getElementById('printBtn').addEventListener('click', ()=> {
    const printWindow = window.open('','_blank','width=800,height=600');
    printWindow.document.write('<html dir="rtl"><head><meta charset="utf-8"><title>Ø·Ø¨Ø§Ø¹Ø©</title></head><body>');
    printWindow.document.write('<h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù…Ø±ØªØ¬Ø¹)</h3>');
    printWindow.document.write(document.getElementById('itemsArea').innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  });

  // theme toggle
  document.getElementById('themeBtn').addEventListener('click', ()=> {
    const html = document.documentElement;
    const cur = html.getAttribute('data-theme') || 'light';
    html.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
  });

  // utility log
  function log(msg){
    const el = document.createElement('div');
    el.textContent = `${new Date().toLocaleTimeString()} â€” ${msg}`;
    logArea.prepend(el);
  }

  // initial render
  renderInvoices();
  // load first invoice by default for demo
  setTimeout(()=> {
    selectedInvoiceId = invoices[0].id;
    renderInvoices();
    loadInvoice(selectedInvoiceId);
  }, 200);

});
</script>
</body>
</html>
